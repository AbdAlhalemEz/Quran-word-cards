<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق تعلم القرآن للأطفال</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #a8d0ff 0%, #8ecbff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }
        
        body.girl-theme {
            background: linear-gradient(135deg, #ffd1dc 0%, #c9e9ff 100%);
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a3a5f 0%, #0d2a4a 100%);
        }
        
        body.girl-theme.dark-mode {
            background: linear-gradient(135deg, #4a235a 0%, #3a1a4a 100%);
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
            transition: all 0.3s;
            position: relative;
            border: 5px solid #4d9be6;
        }
        
        body.girl-theme .container {
            border: 5px solid #ff6b9d;
        }
        
        body.dark-mode .container {
            background-color: #1e3a5f;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 5px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .container {
            background-color: #3a1a4a;
            border: 5px solid #8e44ad;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, #4d9be6 0%, #3a7bd5 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
            position: relative;
            border-bottom: 5px solid #3a7bd5;
        }
        
        body.girl-theme header {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e6b 100%);
            border-bottom: 5px solid #ff4d8d;
        }
        
        .menu-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .menu-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .profile-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .profile-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .theme-toggle {
            position: absolute;
            left: 80px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .dark-mode-toggle {
            position: absolute;
            left: 140px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-family: 'Traditional Arabic', 'Scheherazade New', serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        /* Side Navigation */
        .side-nav {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
            border-left: 5px solid #4d9be6;
        }
        
        body.girl-theme .side-nav {
            border-left: 5px solid #ff6b9d;
        }
        
        body.dark-mode .side-nav {
            background: #1e3a5f;
            color: #ecf0f1;
            border-left: 5px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .side-nav {
            background: #3a1a4a;
            border-left: 5px solid #8e44ad;
        }
        
        .side-nav.active {
            right: 0;
        }
        
        .nav-header {
            background: linear-gradient(135deg, #4d9be6 0%, #3a7bd5 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid #3a7bd5;
        }
        
        body.girl-theme .nav-header {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e6b 100%);
            border-bottom: 3px solid #ff4d8d;
        }
        
        .close-nav {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-nav:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        .nav-content {
            padding: 20px;
        }
        
        .nav-section {
            margin-bottom: 25px;
            border-radius: 15px;
            padding: 15px;
            background: rgba(168, 208, 255, 0.3);
        }
        
        body.girl-theme .nav-section {
            background: rgba(255, 209, 220, 0.3);
        }
        
        body.dark-mode .nav-section {
            background: rgba(30, 58, 95, 0.5);
        }
        
        body.girl-theme.dark-mode .nav-section {
            background: rgba(58, 26, 74, 0.5);
        }
        
        .nav-section h3 {
            color: #4d9be6;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4d9be6;
            text-align: right;
            font-size: 1.4rem;
        }
        
        body.girl-theme .nav-section h3 {
            color: #ff6b9d;
            border-bottom: 2px solid #ff6b9d;
        }
        
        body.dark-mode .nav-section h3 {
            color: #3a7bd5;
            border-bottom: 2px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .nav-section h3 {
            color: #8e44ad;
            border-bottom: 2px solid #8e44ad;
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid #a8d0ff;
            cursor: pointer;
            text-align: right;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.7);
        }
        
        body.girl-theme .progress-item {
            border-bottom: 1px solid #ffd1dc;
        }
        
        body.dark-mode .progress-item {
            border-bottom: 1px solid #3a7bd5;
            background: rgba(30, 58, 95, 0.7);
        }
        
        body.girl-theme.dark-mode .progress-item {
            border-bottom: 1px solid #8e44ad;
            background: rgba(58, 26, 74, 0.7);
        }
        
        .progress-item:hover {
            background: #a8d0ff;
            transform: translateX(5px);
        }
        
        body.girl-theme .progress-item:hover {
            background: #ffd1dc;
        }
        
        body.dark-mode .progress-item:hover {
            background: #3a7bd5;
        }
        
        body.girl-theme.dark-mode .progress-item:hover {
            background: #8e44ad;
        }
        
        .progress-bar {
            flex: 1;
            height: 12px;
            background: #a8d0ff;
            border-radius: 6px;
            margin: 0 15px;
            overflow: hidden;
            border: 1px solid #4d9be6;
        }
        
        body.girl-theme .progress-bar {
            background: #ffd1dc;
            border: 1px solid #ff6b9d;
        }
        
        body.dark-mode .progress-bar {
            background: #1e3a5f;
            border: 1px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .progress-bar {
            background: #3a1a4a;
            border: 1px solid #8e44ad;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4d9be6 0%, #3a7bd5 100%);
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        
        body.girl-theme .progress-fill {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e6b 100%);
        }
        
        .progress-percent {
            font-weight: 600;
            color: #4d9be6;
            min-width: 45px;
            text-align: left;
            font-size: 1.1rem;
        }
        
        body.girl-theme .progress-percent {
            color: #ff6b9d;
        }
        
        body.dark-mode .progress-percent {
            color: #3a7bd5;
        }
        
        body.girl-theme.dark-mode .progress-percent {
            color: #8e44ad;
        }
        
        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .profile-modal.active {
            display: flex;
        }
        
        .profile-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 5px solid #4d9be6;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        body.girl-theme .profile-content {
            border: 5px solid #ff6b9d;
        }
        
        body.dark-mode .profile-content {
            background: #1e3a5f;
            color: #ecf0f1;
            border: 5px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .profile-content {
            background: #3a1a4a;
            border: 5px solid #8e44ad;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .close-profile {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #4d9be6;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        body.girl-theme .close-profile {
            color: #ff6b9d;
        }
        
        body.dark-mode .close-profile {
            color: #3a7bd5;
        }
        
        body.girl-theme.dark-mode .close-profile {
            color: #8e44ad;
        }
        
        .close-profile:hover {
            background: rgba(77, 155, 230, 0.1);
            transform: scale(1.1);
        }
        
        body.girl-theme .close-profile:hover {
            background: rgba(255, 107, 157, 0.1);
        }
        
        body.dark-mode .close-profile:hover {
            background: rgba(58, 123, 213, 0.1);
        }
        
        body.girl-theme.dark-mode .close-profile:hover {
            background: rgba(142, 68, 173, 0.1);
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #a8d0ff;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid #4d9be6;
        }
        
        body.girl-theme .stat-card {
            background: #ffd1dc;
            border: 2px solid #ff6b9d;
        }
        
        body.dark-mode .stat-card {
            background: #3a7bd5;
            border: 2px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .stat-card {
            background: #8e44ad;
            border: 2px solid #8e44ad;
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: #4d9be6;
            margin-bottom: 8px;
        }
        
        body.girl-theme .stat-number {
            color: #ff6b9d;
        }
        
        body.dark-mode .stat-number {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode .stat-number {
            color: #ffd1dc;
        }
        
        .stat-label {
            color: #4d9be6;
            font-size: 1rem;
            font-weight: 600;
        }
        
        body.girl-theme .stat-label {
            color: #ff6b9d;
        }
        
        body.dark-mode .stat-label {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode .stat-label {
            color: #ffd1dc;
        }
        
        /* Main Content */
        .controls {
            padding: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            background-color: #a8d0ff;
            border-bottom: 3px solid #4d9be6;
        }
        
        body.girl-theme .controls {
            background-color: #ffd1dc;
            border-bottom: 3px solid #ff6b9d;
        }
        
        body.dark-mode .controls {
            background-color: #3a7bd5;
            border-bottom: 3px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .controls {
            background-color: #8e44ad;
            border-bottom: 3px solid #8e44ad;
        }
        
        .select-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 220px;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4d9be6;
            text-align: right;
            font-size: 1.1rem;
        }
        
        body.girl-theme label {
            color: #ff6b9d;
        }
        
        body.dark-mode label {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode label {
            color: #ffd1dc;
        }
        
        select, button, input {
            padding: 15px 20px;
            border-radius: 15px;
            border: 3px solid #4d9be6;
            font-size: 1.1rem;
            background-color: white;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        body.girl-theme select, 
        body.girl-theme button, 
        body.girl-theme input {
            border: 3px solid #ff6b9d;
        }
        
        body.dark-mode select, 
        body.dark-mode button, 
        body.dark-mode input {
            background-color: #1e3a5f;
            border: 3px solid #3a7bd5;
            color: #ecf0f1;
        }
        
        body.girl-theme.dark-mode select, 
        body.girl-theme.dark-mode button, 
        body.girl-theme.dark-mode input {
            background-color: #3a1a4a;
            border: 3px solid #8e44ad;
            color: #ecf0f1;
        }
        
        select:focus, button:focus, input:focus {
            outline: none;
            border-color: #3a7bd5;
            box-shadow: 0 0 0 3px rgba(77, 155, 230, 0.3);
        }
        
        body.girl-theme select:focus, 
        body.girl-theme button:focus, 
        body.girl-theme input:focus {
            border-color: #ff4d8d;
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.3);
        }
        
        body.dark-mode select:focus, 
        body.dark-mode button:focus, 
        body.dark-mode input:focus {
            border-color: #3a7bd5;
            box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.3);
        }
        
        body.girl-theme.dark-mode select:focus, 
        body.girl-theme.dark-mode button:focus, 
        body.girl-theme.dark-mode input:focus {
            border-color: #8e44ad;
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.3);
        }
        
        button {
            background: linear-gradient(135deg, #4d9be6 0%, #3a7bd5 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(77, 155, 230, 0.4);
        }
        
        body.girl-theme button {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e6b 100%);
            box-shadow: 0 4px 10px rgba(255, 107, 157, 0.4);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(77, 155, 230, 0.5);
        }
        
        body.girl-theme button:hover {
            box-shadow: 0 6px 15px rgba(255, 107, 157, 0.5);
        }
        
        body.dark-mode button:hover {
            box-shadow: 0 6px 15px rgba(58, 123, 213, 0.5);
        }
        
        body.girl-theme.dark-mode button:hover {
            box-shadow: 0 6px 15px rgba(142, 68, 173, 0.5);
        }

        /* Autoplay button specific style */
        #autoPlayToggle {
            flex: 1;
            min-width: 180px;
            margin-top: 25px;
            background: linear-gradient(135deg, #06d6a0 0%, #05b38a 100%);
            box-shadow: 0 4px 10px rgba(6, 214, 160, 0.4);
        }
        
        #autoPlayToggle.playing {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
        }
        
        #autoPlayToggle:hover {
            box-shadow: 0 6px 15px rgba(6, 214, 160, 0.5);
        }
        
        #autoPlayToggle.playing:hover {
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
        }
        
        .card-container {
            padding: 35px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 450px;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.5);
        }
        
        body.dark-mode .card-container {
            background: rgba(30, 58, 95, 0.5);
        }
        
        body.girl-theme.dark-mode .card-container {
            background: rgba(58, 26, 74, 0.5);
        }
        
        /* إطارات كروت مزخرفة للأطفال */
        .word-card {
            width: 100%;
            max-width: 550px;
            padding: 35px;
            text-align: center;
            transition: opacity 0.45s cubic-bezier(.22,.9,.29,1), background-color 0.3s, transform 0.3s ease-out;
            cursor: pointer;
            touch-action: pan-y;
            position: relative;
            background-color: #f0f8ff;
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        body.girl-theme .word-card {
            background-color: #fff9f9;
        }
        
        body.dark-mode .word-card {
            background-color: #1e3a5f;
        }
        
        body.girl-theme.dark-mode .word-card {
            background-color: #3a1a4a;
        }

        /* الإطارات المزخرفة للأطفال */
        .word-card.kids-frame-1 {
            border: 12px solid;
            border-image: linear-gradient(45deg, #4d9be6, #3a7bd5, #a8d0ff, #06d6a0) 1;
            padding: 25px;
            background: 
                linear-gradient(white, white) padding-box,
                linear-gradient(45deg, #4d9be6, #3a7bd5, #a8d0ff, #06d6a0) border-box;
            border-radius: 20px;
        }
        
        body.girl-theme .word-card.kids-frame-1 {
            border-image: linear-gradient(45deg, #ff6b9d, #ff8e6b, #ffd166, #06d6a0) 1;
            background: 
                linear-gradient(white, white) padding-box,
                linear-gradient(45deg, #ff6b9d, #ff8e6b, #ffd166, #06d6a0) border-box;
        }
        
        body.dark-mode .word-card.kids-frame-1 {
            background: 
                linear-gradient(#1e3a5f, #1e3a5f) padding-box,
                linear-gradient(45deg, #4d9be6, #3a7bd5, #a8d0ff, #06d6a0) border-box;
        }
        
        body.girl-theme.dark-mode .word-card.kids-frame-1 {
            background: 
                linear-gradient(#3a1a4a, #3a1a4a) padding-box,
                linear-gradient(45deg, #ff6b9d, #ff8e6b, #ffd166, #06d6a0) border-box;
        }
        
        .word-card.kids-frame-2 {
            border: 10px solid #a8d0ff;
            border-radius: 25px;
            padding: 30px;
            background: linear-gradient(145deg, #e6f2ff, #ffffff);
            box-shadow: 
                0 0 25px rgba(168, 208, 255, 0.6),
                inset 0 0 15px rgba(168, 208, 255, 0.2);
            position: relative;
        }
        
        body.girl-theme .word-card.kids-frame-2 {
            border: 10px solid #ffd166;
            background: linear-gradient(145deg, #fff9e6, #ffffff);
            box-shadow: 
                0 0 25px rgba(255, 209, 102, 0.6),
                inset 0 0 15px rgba(255, 209, 102, 0.2);
        }
        
        .word-card.kids-frame-2::before {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            left: -5px;
            bottom: -5px;
            border: 3px solid #a8d0ff;
            border-radius: 30px;
            pointer-events: none;
        }
        
        body.girl-theme .word-card.kids-frame-2::before {
            border: 3px solid #ffd166;
        }
        
        body.dark-mode .word-card.kids-frame-2 {
            background: linear-gradient(145deg, #1a3a5f, #1e3a5f);
        }
        
        body.girl-theme.dark-mode .word-card.kids-frame-2 {
            background: linear-gradient(145deg, #3a1a4a, #3a1a4a);
        }
        
        .word-card.kids-frame-3 {
            border: 8px solid transparent;
            background: 
                linear-gradient(white, white) padding-box,
                repeating-linear-gradient(
                    45deg,
                    #4d9be6,
                    #4d9be6 12px,
                    #06d6a0 12px,
                    #06d6a0 24px,
                    #a8d0ff 24px,
                    #a8d0ff 36px,
                    #4d9be6 36px
                ) border-box;
            border-radius: 15px;
            padding: 32px;
        }
        
        body.girl-theme .word-card.kids-frame-3 {
            background: 
                linear-gradient(white, white) padding-box,
                repeating-linear-gradient(
                    45deg,
                    #ff6b9d,
                    #ff6b9d 12px,
                    #06d6a0 12px,
                    #06d6a0 24px,
                    #ffd166 24px,
                    #ffd166 36px,
                    #ff6b9d 36px
                ) border-box;
        }
        
        body.dark-mode .word-card.kids-frame-3 {
            background: 
                linear-gradient(#1e3a5f, #1e3a5f) padding-box,
                repeating-linear-gradient(
                    45deg,
                    #4d9be6,
                    #4d9be6 12px,
                    #06d6a0 12px,
                    #06d6a0 24px,
                    #a8d0ff 24px,
                    #a8d0ff 36px,
                    #4d9be6 36px
                ) border-box;
        }
        
        body.girl-theme.dark-mode .word-card.kids-frame-3 {
            background: 
                linear-gradient(#3a1a4a, #3a1a4a) padding-box,
                repeating-linear-gradient(
                    45deg,
                    #ff6b9d,
                    #ff6b9d 12px,
                    #06d6a0 12px,
                    #06d6a0 24px,
                    #ffd166 24px,
                    #ffd166 36px,
                    #ff6b9d 36px
                ) border-box;
        }
        
        .word-card.kids-frame-4 {
            border: 5px solid #06d6a0;
            border-radius: 30px;
            padding: 35px;
            background: #f5fff9;
            position: relative;
            overflow: hidden;
        }
        
        body.girl-theme .word-card.kids-frame-4 {
            border: 5px solid #06d6a0;
            background: #f5fff9;
        }
        
        .word-card.kids-frame-4::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            left: 8px;
            bottom: 8px;
            border: 3px solid #06d6a0;
            border-radius: 25px;
            pointer-events: none;
        }
        
        .word-card.kids-frame-4::after {
            content: '⭐';
            position: absolute;
            top: 15px;
            right: 15px;
            color: #ffd166;
            font-size: 2rem;
            text-shadow: 0 0 5px rgba(255, 209, 102, 0.8);
        }
        
        body.dark-mode .word-card.kids-frame-4 {
            background: #1a3a5f;
            border-color: #06d6a0;
        }
        
        body.girl-theme.dark-mode .word-card.kids-frame-4 {
            background: #3a1a4a;
            border-color: #06d6a0;
        }
        
        .word-card.kids-frame-5 {
            border: 10px solid #4d9be6;
            border-radius: 20px;
            padding: 30px;
            background: linear-gradient(145deg, #e6f2ff, #ffffff);
            box-shadow: 
                0 0 25px rgba(77, 155, 230, 0.4),
                inset 0 0 15px rgba(77, 155, 230, 0.1);
            position: relative;
        }
        
        body.girl-theme .word-card.kids-frame-5 {
            border: 10px solid #4d9be6;
            background: linear-gradient(145deg, #e6f2ff, #ffffff);
            box-shadow: 
                0 0 25px rgba(77, 155, 230, 0.4),
                inset 0 0 15px rgba(77, 155, 230, 0.1);
        }
        
        .word-card.kids-frame-5::before {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            left: -5px;
            bottom: -5px;
            border: 3px solid #4d9be6;
            border-radius: 25px;
            pointer-events: none;
        }
        
        body.dark-mode .word-card.kids-frame-5 {
            background: linear-gradient(145deg, #1a3a5f, #1e3a5f);
        }
        
        body.girl-theme.dark-mode .word-card.kids-frame-5 {
            background: linear-gradient(145deg, #3a1a4a, #3a1a4a);
        }
        
        .word-card.kids-frame-6 {
            border: 8px solid transparent;
            border-image: 
                repeating-linear-gradient(
                    45deg,
                    #4d9be6,
                    #4d9be6 10px,
                    #a8d0ff 10px,
                    #a8d0ff 20px
                ) 1;
            border-radius: 15px;
            padding: 32px;
            background: white;
        }
        
        body.girl-theme .word-card.kids-frame-6 {
            border-image: 
                repeating-linear-gradient(
                    45deg,
                    #ff6b9d,
                    #ff6b9d 10px,
                    #ffd166 10px,
                    #ffd166 20px
                ) 1;
            background: white;
        }
        
        body.dark-mode .word-card.kids-frame-6 {
            background: #1e3a5f;
        }
        
        body.girl-theme.dark-mode .word-card.kids-frame-6 {
            background: #3a1a4a;
        }

        /* الكلاس لإلغاء الانتقال أثناء السحب */
        .word-card.dragging {
            transition: none;
            cursor: grabbing;
        }

        /* الرسوم المتحركة للتنقل */
        .word-card.slide-out-left {
            transform: translateX(-150%) scale(0.8);
            opacity: 0;
        }

        .word-card.slide-in-right {
            transform: translateX(150%) scale(0.8);
            opacity: 0;
        }
        
        .word-card.active {
            transform: translateX(0) scale(1);
            opacity: 1;
        }
        
        .word-card:hover {
            transform: translateY(-5px) scale(1.02);
        }
        
        .arabic-text {
            font-size: 3.8rem;
            font-weight: 800;
            font-family: 'Traditional Arabic', 'Scheherazade New', serif;
            margin-bottom: 25px;
            color: #4d9be6;
            line-height: 1.4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        body.girl-theme .arabic-text {
            color: #ff6b9d;
        }
        
        body.dark-mode .arabic-text {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode .arabic-text {
            color: #ffd1dc;
        }
        
        .transliteration {
            font-size: 2rem;
            color: #06d6a0;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        body.dark-mode .transliteration {
            color: #a8d0ff;
        }
        
        .translation {
            font-size: 1.6rem;
            color: #3a7bd5;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        body.girl-theme .translation {
            color: #4d9be6;
        }
        
        body.dark-mode .translation {
            color: #c9e9ff;
        }
        
        body.girl-theme.dark-mode .translation {
            color: #c9e9ff;
        }
        
        footer {
            margin-top: 25px;
            text-align: center;
            color: #4d9be6;
            font-size: 1rem;
            font-weight: 500;
        }
        
        body.girl-theme footer {
            color: #ff6b9d;
        }
        
        body.dark-mode footer {
            color: #c9e9ff;
        }
        
        body.girl-theme.dark-mode footer {
            color: #c9e9ff;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 25px;
            font-size: 1.4rem;
            color: #4d9be6;
        }
        
        body.girl-theme .loading {
            color: #ff6b9d;
        }
        
        .repeat-indicator {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #4d9be6;
            font-weight: 600;
        }
        
        body.girl-theme .repeat-indicator {
            color: #ff6b9d;
        }
        
        body.dark-mode .repeat-indicator {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode .repeat-indicator {
            color: #ffd1dc;
        }

        /* نماذج العرض الكامل */
        body.fullscreen-mode {
            background: white;
            padding: 0;
            justify-content: center;
            overflow: hidden;
        }
        
        body.girl-theme.fullscreen-mode {
            background: white;
        }
        
        body.fullscreen-mode.dark-mode {
            background: #1e3a5f;
        }
        
        body.girl-theme.fullscreen-mode.dark-mode {
            background: #3a1a4a;
        }
        
        body.fullscreen-mode .container {
            display: none;
        }
        
        body.fullscreen-mode footer {
            display: none;
        }
        
        body.fullscreen-mode #fullscreen-card {
            display: flex !important;
            position: fixed;
            top: 0;
            right: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        body.girl-theme.fullscreen-mode #fullscreen-card {
            background: white;
        }
        
        body.fullscreen-mode.dark-mode #fullscreen-card {
            background: #1e3a5f;
        }
        
        body.girl-theme.fullscreen-mode.dark-mode #fullscreen-card {
            background: #3a1a4a;
        }
        
        body.fullscreen-mode #fullscreen-card .word-card {
            transform: scale(1.4);
            max-width: 650px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: #4d9be6;
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        body.girl-theme .fullscreen-btn {
            color: #ff6b9d;
        }
        
        body.dark-mode .fullscreen-btn {
            color: #a8d0ff;
            background: rgba(255,255,255,0.1);
        }
        
        body.girl-theme.dark-mode .fullscreen-btn {
            color: #ffd1dc;
        }
        
        .fullscreen-btn:hover {
            background: rgba(0,0,0,0.2);
            transform: scale(1.1);
        }
        
        body.dark-mode .fullscreen-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* زر التشغيل التلقائي في العرض الكامل */
        #fullscreen-autoplay-btn {
            position: absolute;
            bottom: 25px;
            left: 25px;
            background: linear-gradient(135deg, #06d6a0 0%, #05b38a 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.8rem;
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(6, 214, 160, 0.5);
        }

        #fullscreen-autoplay-btn.playing {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5);
        }

        #fullscreen-autoplay-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(6, 214, 160, 0.6);
        }
        
        #fullscreen-autoplay-btn.playing:hover {
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }
        
        /* Overlay for modals */
        .overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* قسم التخصيص */
        .customize-section {
            background: rgba(168, 208, 255, 0.4);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #4d9be6;
        }
        
        body.girl-theme .customize-section {
            background: rgba(255, 209, 220, 0.4);
            border: 2px solid #ff6b9d;
        }
        
        body.dark-mode .customize-section {
            background: rgba(30, 58, 95, 0.5);
            border: 2px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .customize-section {
            background: rgba(58, 26, 74, 0.5);
            border: 2px solid #8e44ad;
        }
        
        .customize-section h4 {
            margin-bottom: 15px;
            color: #4d9be6;
            text-align: right;
            font-size: 1.2rem;
        }
        
        body.girl-theme .customize-section h4 {
            color: #ff6b9d;
        }
        
        body.dark-mode .customize-section h4 {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode .customize-section h4 {
            color: #ffd1dc;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4d9be6;
        }
        
        body.girl-theme .form-group label {
            color: #ff6b9d;
        }
        
        body.dark-mode .form-group label {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode .form-group label {
            color: #ffd1dc;
        }
        
        .form-group input:not([type="checkbox"]), .form-group select {
            width: 100%;
            padding: 12px 15px;
        }

        /* أنماط خاصة للخانات الاختيارية */
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #a8d0ff;
        }
        
        body.girl-theme .checkbox-group {
            border-bottom: 1px solid #ffd1dc;
        }
        
        body.dark-mode .checkbox-group {
            border-bottom: 1px solid #3a7bd5;
        }
        
        body.girl-theme.dark-mode .checkbox-group {
            border-bottom: 1px solid #8e44ad;
        }

        .checkbox-group label {
            flex-grow: 1;
            margin: 0;
            color: #4d9be6;
            font-weight: 500;
        }
        
        body.girl-theme .checkbox-group label {
            color: #ff6b9d;
        }
        
        body.dark-mode .checkbox-group label {
            color: #a8d0ff;
        }
        
        body.girl-theme.dark-mode .checkbox-group label {
            color: #ffd1dc;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            min-width: 25px;
            height: 25px;
            cursor: pointer;
            accent-color: #4d9be6;
        }
        
        body.girl-theme .checkbox-group input[type="checkbox"] {
            accent-color: #ff6b9d;
        }
        
        body.dark-mode .checkbox-group input[type="checkbox"] {
            accent-color: #3a7bd5;
        }
        
        body.girl-theme.dark-mode .checkbox-group input[type="checkbox"] {
            accent-color: #8e44ad;
        }
        
        /* اختيار تصميم الكروت */
        .card-design-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .card-design-option {
            padding: 15px;
            border: 3px solid #a8d0ff;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        body.girl-theme .card-design-option {
            border: 3px solid #ffd1dc;
            background: white;
        }
        
        body.dark-mode .card-design-option {
            border: 3px solid #3a7bd5;
            background: #1e3a5f;
        }
        
        body.girl-theme.dark-mode .card-design-option {
            border: 3px solid #8e44ad;
            background: #3a1a4a;
        }
        
        .card-design-option:hover {
            border-color: #4d9be6;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(77, 155, 230, 0.3);
        }
        
        body.girl-theme .card-design-option:hover {
            border-color: #ff6b9d;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);
        }
        
        body.dark-mode .card-design-option:hover {
            border-color: #3a7bd5;
            box-shadow: 0 5px 15px rgba(58, 123, 213, 0.3);
        }
        
        body.girl-theme.dark-mode .card-design-option:hover {
            border-color: #8e44ad;
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3);
        }
        
        .card-design-option.active {
            border-color: #3a7bd5;
            background-color: rgba(77, 155, 230, 0.1);
            box-shadow: 0 0 15px rgba(77, 155, 230, 0.4);
        }
        
        body.girl-theme .card-design-option.active {
            border-color: #ff4d8d;
            background-color: rgba(255, 107, 157, 0.1);
            box-shadow: 0 0 15px rgba(255, 107, 157, 0.4);
        }
        
        body.dark-mode .card-design-option.active {
            background-color: rgba(58, 123, 213, 0.2);
            box-shadow: 0 0 15px rgba(58, 123, 213, 0.4);
        }
        
        body.girl-theme.dark-mode .card-design-option.active {
            background-color: rgba(142, 68, 173, 0.2);
            box-shadow: 0 0 15px rgba(142, 68, 173, 0.4);
        }
        
        .card-design-preview {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f0f8ff;
        }
        
        body.girl-theme .card-design-preview {
            background-color: #fff9f9;
        }
        
        body.dark-mode .card-design-preview {
            background-color: #1e3a5f;
        }
        
        body.girl-theme.dark-mode .card-design-preview {
            background-color: #3a1a4a;
        }
        
        .kids-frame-1 .card-design-preview {
            border: 3px solid;
            border-image: linear-gradient(45deg, #4d9be6, #3a7bd5, #a8d0ff, #06d6a0) 1;
        }
        
        body.girl-theme .kids-frame-1 .card-design-preview {
            border-image: linear-gradient(45deg, #ff6b9d, #ff8e6b, #ffd166, #06d6a0) 1;
        }
        
        .kids-frame-2 .card-design-preview {
            border: 2px solid #a8d0ff;
            background: linear-gradient(45deg, #e6f2ff, #a8d0ff);
        }
        
        body.girl-theme .kids-frame-2 .card-design-preview {
            border: 2px solid #ffd166;
            background: linear-gradient(45deg, #fff9e6, #ffd166);
        }
        
        .kids-frame-3 .card-design-preview {
            background: repeating-linear-gradient(45deg, #4d9be6, #4d9be6 5px, #06d6a0 5px, #06d6a0 10px, #a8d0ff 10px, #a8d0ff 15px);
        }
        
        body.girl-theme .kids-frame-3 .card-design-preview {
            background: repeating-linear-gradient(45deg, #ff6b9d, #ff6b9d 5px, #06d6a0 5px, #06d6a0 10px, #ffd166 10px, #ffd166 15px);
        }
        
        .kids-frame-4 .card-design-preview {
            border: 2px solid #06d6a0;
            background: #f5fff9;
            position: relative;
        }
        
        body.girl-theme .kids-frame-4 .card-design-preview {
            border: 2px solid #06d6a0;
            background: #f5fff9;
        }
        
        .kids-frame-4 .card-design-preview::after {
            content: '⭐';
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            color: #ffd166;
        }
        
        .kids-frame-5 .card-design-preview {
            border: 2px solid #4d9be6;
            background: linear-gradient(45deg, #e6f2ff, #4d9be6);
        }
        
        body.girl-theme .kids-frame-5 .card-design-preview {
            border: 2px solid #4d9be6;
            background: linear-gradient(45deg, #e6f2ff, #4d9be6);
        }
        
        .kids-frame-6 .card-design-preview {
            background: repeating-linear-gradient(45deg, #4d9be6, #4d9be6 5px, #a8d0ff 5px, #a8d0ff 10px);
        }
        
        body.girl-theme .kids-frame-6 .card-design-preview {
            background: repeating-linear-gradient(45deg, #ff6b9d, #ff6b9d 5px, #ffd166 5px, #ffd166 10px);
        }
        
        @media (max-width: 600px) {
            .arabic-text {
                font-size: 2.8rem;
            }

            .transliteration {
                font-size: 1.6rem;
            }

            .translation {
                font-size: 1.3rem;
            }

            .controls {
                flex-direction: column;
            }

            body.fullscreen-mode #fullscreen-card .word-card {
                transform: scale(1.2);
                max-width: 95%;
            }

            .side-nav {
                width: 100%;
                right: -100%;
            }

            .user-stats {
                grid-template-columns: 1fr;
            }

            #fullscreen-autoplay-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
                bottom: 15px;
                left: 15px;
            }

            .card-design-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .theme-toggle, .dark-mode-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    
    <div class="side-nav" id="sideNav">
        <div class="nav-header">
            <h3 data-i18n="nav_title">التنقل</h3>
            <button class="close-nav" id="closeNav">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="nav-content">
            <div class="nav-section">
                <h3 data-i18n="display_settings">إعدادات العرض</h3>
                <div class="customize-section">
                    <div class="form-group">
                        <label for="app-language" data-i18n="label_language">اللغة:</label>
                        <select id="app-language">
                            <option value="ar">العربية</option>
                            <option value="en">English</option>
                            <option value="es">Español</option>
                        </select>
                    </div>

                    <h4 data-i18n="display_toggles_title">رؤية المحتوى:</h4>
                    <div class="checkbox-group">
                        <label for="toggle-translit" data-i18n="toggle_translit">عرض النطق (النقل الصوتي)</label>
                        <input type="checkbox" id="toggle-translit" checked>
                    </div>
                    <div class="checkbox-group">
                        <label for="toggle-translation" data-i18n="toggle_translation">عرض الترجمة</label>
                        <input type="checkbox" id="toggle-translation" checked>
                    </div>
                    <div class="checkbox-group">
                        <label for="toggle-progress" data-i18n="toggle_progress">عرض عدد الكلمات / التقدم</label>
                        <input type="checkbox" id="toggle-progress" checked>
                    </div>
                    <div class="checkbox-group">
                        <label for="toggle-repeat" data-i18n="toggle_repeat">عرض مؤشر التكرار</label>
                        <input type="checkbox" id="toggle-repeat" checked>
                    </div>
                    
                    <h4 data-i18n="card_design_title">تصميم الإطار:</h4>
                    <div class="card-design-options">
                        <div class="card-design-option kids-frame-1 active" data-design="kids-frame-1">
                            <div class="card-design-preview"></div>
                            <span>إطار ألوان مزخرفة</span>
                        </div>
                        <div class="card-design-option kids-frame-2" data-design="kids-frame-2">
                            <div class="card-design-preview"></div>
                            <span>إطار أزرق</span>
                        </div>
                        <div class="card-design-option kids-frame-3" data-design="kids-frame-3">
                            <div class="card-design-preview"></div>
                            <span>إطار فسيفساء</span>
                        </div>
                        <div class="card-design-option kids-frame-4" data-design="kids-frame-4">
                            <div class="card-design-preview"></div>
                            <span>إطار أخضر مزخرف</span>
                        </div>
                        <div class="card-design-option kids-frame-5" data-design="kids-frame-5">
                            <div class="card-design-preview"></div>
                            <span>إطار أزرق فاتح</span>
                        </div>
                        <div class="card-design-option kids-frame-6" data-design="kids-frame-6">
                            <div class="card-design-preview"></div>
                            <span>إطار زدوج</span>
                        </div>
                    </div>
                    
                    <h4 data-i18n="text_styles_title">أنماط النص:</h4>
                    <div class="form-group">
                        <label for="card-color" data-i18n="label_card_color">لون خلفية البطاقة:</label>
                        <input type="color" id="card-color" value="#f0f8ff">
                    </div>
                    <div class="form-group">
                        <label for="arabic-text-color" data-i18n="label_arabic_color">لون النص العربي:</label>
                        <input type="color" id="arabic-text-color" value="#4d9be6">
                    </div>
                    <div class="form-group">
                        <label for="translit-text-color" data-i18n="label_translit_color">لون النقل الصوتي:</label>
                        <input type="color" id="translit-text-color" value="#06d6a0">
                    </div>
                    <div class="form-group">
                        <label for="translation-text-color" data-i18n="label_translation_color">لون الترجمة:</label>
                        <input type="color" id="translation-text-color" value="#3a7bd5">
                    </div>
                    <div class="form-group">
                        <label for="arabic-text-size" data-i18n="label_arabic_size">حجم النص العربي (بكسل):</label>
                        <input type="number" id="arabic-text-size" min="24" max="120" value="56">
                    </div>
                    <div class="form-group">
                        <label for="translit-text-size" data-i18n="label_translit_size">حجم النقل الصوتي (بكسل):</label>
                        <input type="number" id="translit-text-size" min="12" max="48" value="28">
                    </div>
                    <div class="form-group">
                        <label for="translation-text-size" data-i18n="label_translation_size">حجم الترجمة (بكسل):</label>
                        <input type="number" id="translation-text-size" min="12" max="32" value="18">
                    </div>
                </div>

                <h3 data-i18n="autoplay_settings">إعدادات التشغيل التلقائي</h3>
                <div class="customize-section">
                    <div class="form-group">
                        <label for="repeat-count" data-i18n="label_repeat_count">عدد تكرار الكلمة:</label>
                        <input type="number" id="repeat-count" min="0" max="10" value="1">
                    </div>
                    <div class="form-group">
                        <label for="delay-ms" data-i18n="label_delay_ms">التأخير بين الكلمات (مللي ثانية):</label>
                        <input type="number" id="delay-ms" min="500" max="5000" step="100" value="1000">
                    </div>
                </div>
                
                <button id="save-display-settings" style="width:100%">
                    <i class="fas fa-save"></i> <span data-i18n="save_settings">حفظ الإعدادات</span>
                </button>
            </div>

            <div class="nav-section">
                <h3>إعدادات سريعة</h3>
                <button id="side-theme-toggle" style="width:100%; margin-bottom:15px;">
                    <i class="fas fa-palette"></i> تبديل الموضوع (👦/👧)
                </button>
                <button id="side-dark-mode-toggle" style="width:100%;">
                    <i class="fas fa-moon"></i> الوضع المظلم
                </button>
            </div>
            
            <div class="nav-section">
                <h3 data-i18n="progress_title">نظرة عامة على التقدم</h3>
                <div class="progress-item" data-surah="1">
                    <span>الفاتحة</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-percent">0%</span>
                </div>
                <div class="progress-item" data-surah="2">
                    <span>البقرة</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-percent">0%</span>
                </div>
                <div class="progress-item" data-surah="112">
                    <span>الإخلاص</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-percent">0%</span>
                </div>
                <div class="progress-item" data-surah="113">
                    <span>الفلق</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-percent">0%</span>
                </div>
                <div class="progress-item" data-surah="114">
                    <span>الناس</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-percent">0%</span>
                </div>
            </div>
            
            <div class="nav-section">
                <h3 data-i18n="quick_actions">إجراءات سريعة</h3>
                <button id="bookmarks-btn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-bookmark"></i> <span data-i18n="bookmarks">الإشارات المرجعية</span>
                </button>
                <button id="review-btn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-history"></i> <span data-i18n="review">مراجعة</span>
                </button>
                <button id="statistics-btn" style="width: 100%;">
                    <i class="fas fa-chart-line"></i> <span data-i18n="statistics">الإحصائيات</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <div class="profile-header">
                <h2 data-i18n="profile_title">ملفك الشخصي</h2>
                <button class="close-profile" id="closeProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="user-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalWords">0</div>
                    <div class="stat-label" data-i18n="words_learned">الكلمات المُتعلَّمة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedSurahs">0</div>
                    <div class="stat-label" data-i18n="surahs_completed">السور المكتملة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="learningDays">0</div>
                    <div class="stat-label" data-i18n="learning_days">أيام التعلم</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentStreak">0</div>
                    <div class="stat-label" data-i18n="day_streak">سلسلة الأيام</div>
                </div>
            </div>
            
            <div class="nav-section">
                <h3 data-i18n="settings">الإعدادات</h3>
                <button id="backup-btn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-save"></i> <span data-i18n="backup_progress">نسخ التقدم احتياطيًا</span>
                </button>
                <button id="export-btn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-download"></i> <span data-i18n="export_data">تصدير البيانات</span>
                </button>
                <button id="switch-profile-btn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-user-plus"></i> <span data-i18n="switch_profile">تبديل الملف الشخص
ي</span>

                </button>
                <button id="logout-btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);">
                    <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">تسجيل الخروج</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <button class="menu-btn" id="menuBtn">
                <i class="fas fa-robot"></i>
            </button>
           <h1>حسان معلم القراّن</h1>
           <p class="subtitle">تعل القرآن بطريقةتعة وسلية</p>
            <button class="theme-toggle" id="themeToggle">
                <span aria-label="boy">👦</span>
            </button>
            <button class="dark-mode-toggle" id="darkModeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <button class="profile-btn" id="profileBtn">
                <i class="fas fa-user-astronaut"></i>
            </button>
         </header>
        
        <div class="controls">
            <div class="select-group">
                <label for="surah-select" data-i18n="label_select_surah">اختر السورة:</label>
                <select id="surah-select">
                    <option value="">-- اختر سورة --</option>
                    </select>
            </div>
            <button id="autoPlayToggle" style="margin-top: 25px;">
                <i class="fas fa-play"></i> <span id="autoPlayText" data-i18n="start_autoplay">بدء التشغيل التلقائي</span>
            </button>
        </div>
        
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> <span data-i18n="loading_surah">جارٍ تحيل السورة...</span>
        </div>
        
        <div class="card-container">
            <button class="fullscreen-btn" id="fullscreen-btn" title="تبديل العرض الكامل">
                <i class="fas fa-expand"></i>
            </button>
            <div class="word-card active kids-frame-1" id="word-card">
                <div class="arabic-text" id="arabic-text">بِسِْ</div>
                <div class="transliteration" id="transliteration">bis'mi</div>
                <div class="translation" id="translation">In (the) name</div>
                
                <div class="audio-status" id="audio-status" aria-hidden="true" style="display:none"></div>
                
                <div class="progress" id="progress">Word 1 of 7</div>
                <div class="repeat-indicator" id="repeat-indicator"></div>
            </div>
        </div>
    </div>
    
    <footer>
        <p data-i18n="footer_text">تطبيق تعل القرآن للأطفال &copy; 2023 | ص لأغراض تعليية</p>
    </footer>

    <div id="fullscreen-card" style="display: none;">
        <button class="fullscreen-btn" id="fullscreen-exit-btn" title="خروج من العرض الكامل">
            <i class="fas fa-compress"></i>
        </button>
        <button id="fullscreen-autoplay-btn">
            <i class="fas fa-play"></i>
        </button>
        <div class="word-card active kids-frame-1" id="fullscreen-word-card">
            <div class="arabic-text" id="fullscreen-arabic-text">بِسِْ</div>
            <div class="transliteration" id="fullscreen-transliteration">bis'mi</div>
            <div class="translation" id="fullscreen-translation">In (the) name</div>
            
            <div class="audio-status" id="fullscreen-audio-status" aria-hidden="true" style="display:none"></div>
            
            <div class="progress" id="fullscreen-progress">Word 1 of 7</div>
            <div class="repeat-indicator" id="fullscreen-repeat-indicator"></div>
        </div>
    </div>

    <script>
    // Enhanced App State with User Progress
    let currentSurah = null;
    let currentWordIndex = 0;
    let currentAyah = 1;
    let autoPlayInterval = null;
    let isPlaying = false;
    let audio = new Audio();
    let currentRepeat = 0;
    let isFullscreen = false;
    let currentLanguage = 'ar';
    let isDarkMode = false;
    let isGirlTheme = false;
    let currentCardDesign = 'kids-frame-1';
    
    // Swipe/Drag State Variables
    let isDragging = false;
    let dragElement = null;
    let dragCardContainer = null;
    let initialX = 0;
    let currentTranslateX = 0;
    const SWIPE_THRESHOLD = 50;

    // Autoplay Settings Variables
    let repeatCount = 1;
    let delayBetweenWords = 1000;

    // Display Toggle State Variables
    let showTransliteration = true;
    let showTranslation = true;
    let showProgress = true;
    let showRepeat = true;
    
    // User progress data
    let userProgress = {
        totalWordsLearned: 0,
        completedSurahs: 0,
        learningDays: 1,
        currentStreak: 1,
        surahProgress: {},
        lastStudyDate: new Date().toDateString()
    };

    // Sample Surah Data (Fallback when JSON files are not available)
    const sampleSurahs = {
        '1': {
            'meta': {
                'surah_name': 'الفاتحة',
                'surah_name_ar': 'الفاتحة',
                'total_ayahs': 7
            },
            '1': {
                'w': [
                    {'c': 'بِسِْ', 'd': 'bis\'mi', 'e': 'In (the) name'},
                    {'c': 'اللَّهِ', 'd': 'allahi', 'e': 'of Allah'},
                    {'c': 'الرَّحَْٰنِ', 'd': 'ar-raḥmāni', 'e': 'the Most Gracious'},
                    {'c': 'الرَّحِيِ', 'd': 'ar-raḥīmi', 'e': 'the Most Merciful'}
                ]
            },
            '2': {
                'w': [
                    {'c': 'الْحَْدُ', 'd': 'al-ḥamdu', 'e': 'All praise'},
                    {'c': 'لِلَّهِ', 'd': 'lillahi', 'e': 'is for Allah'},
                    {'c': 'رَبِّ', 'd': 'rabbi', 'e': 'Lord'},
                    {'c': 'الْعَالَِينَ', 'd': 'al-ʿālamīna', 'e': 'of the worlds'}
                ]
            },
            '3': {
                'w': [
                    {'c': 'الرَّحَْٰنِ', 'd': 'ar-raḥmāni', 'e': 'The Most Gracious'},
                    {'c': 'الرَّحِيِ', 'd': 'ar-raḥīmi', 'e': 'the Most Merciful'}
                ]
            },
            '4': {
                'w': [
                    {'c': 'َالِكِ', 'd': 'māliki', 'e': 'Master'},
                    {'c': 'يَوِْ', 'd': 'yawmi', 'e': 'of the Day'},
                    {'c': 'الدِّينِ', 'd': 'ad-dīni', 'e': 'of Judgment'}
                ]
            },
            '5': {
                'w': [
                    {'c': 'إِيَّاكَ', 'd': 'iyyāka', 'e': 'You alone'},
                    {'c': 'نَعْبُدُ', 'd': 'naʿbudu', 'e': 'we worship'},
                    {'c': 'وَإِيَّاكَ', 'd': 'wa-iyyāka', 'e': 'and You alone'},
                    {'c': 'نَسْتَعِينُ', 'd': 'nastaʿīnu', 'e': 'we ask for help'}
                ]
            },
            '6': {
                'w': [
                    {'c': 'اهْدِنَا', 'd': 'ih\'dinā', 'e': 'Guide us'},
                    {'c': 'الصِّرَاطَ', 'd': 'aṣ-ṣirāṭa', 'e': 'to the path'},
                    {'c': 'الُْسْتَقِيَ', 'd': 'al-mustaqīma', 'e': 'the straight'}
                ]
            },
            '7': {
                'w': [
                    {'c': 'صِرَاطَ', 'd': 'ṣirāṭa', 'e': 'The path'},
                    {'c': 'الَّذِينَ', 'd': 'al-ladhīna', 'e': 'of those'},
                    {'c': 'أَنْعَْتَ', 'd': 'anʿamta', 'e': 'You have blessed'},
                    {'c': 'عَلَيْهِْ', 'd': 'ʿalayhim', 'e': 'upon them'},
                    {'c': 'غَيْرِ', 'd': 'ghayri', 'e': 'not'},
                    {'c': 'الَْغْضُوبِ', 'd': 'al-maghḍūbi', 'e': 'of those who earn wrath'},
                    {'c': 'عَلَيْهِْ', 'd': 'ʿalayhim', 'e': 'upon them'},
                    {'c': 'وَلَا', 'd': 'walā', 'e': 'and not'},
                    {'c': 'الضَّالِّينَ', 'd': 'aḍ-ḍāllīna', 'e': 'of the astray'}
                ]
            }
        },
        '112': {
            'meta': {
                'surah_name': 'الإخلاص',
                'surah_name_ar': 'الإخلاص',
                'total_ayahs': 4
            },
            '1': {
                'w': [
                    {'c': 'قُلْ', 'd': 'qul', 'e': 'Say'},
                    {'c': 'هُوَ', 'd': 'huwa', 'e': 'He'},
                    {'c': 'اللَّهُ', 'd': 'allāhu', 'e': 'Allah'},
                    {'c': 'أَحَدٌ', 'd': 'aḥadun', 'e': 'is One'}
                ]
            },
            '2': {
                'w': [
                    {'c': 'اللَّهُ', 'd': 'allāhu', 'e': 'Allah'},
                    {'c': 'الصََّدُ', 'd': 'aṣ-ṣamadu', 'e': 'the Eternal'}
                ]
            },
            '3': {
                'w': [
                    {'c': 'لَْ', 'd': 'lam', 'e': 'Not'},
                    {'c': 'يَلِدْ', 'd': 'yalid', 'e': 'does He beget'},
                    {'c': 'وَلَْ', 'd': 'wa-lam', 'e': 'nor'},
                    {'c': 'يُولَدْ', 'd': 'yūlad', 'e': 'is He begotten'}
                ]
            },
            '4': {
                'w': [
                    {'c': 'وَلَْ', 'd': 'wa-lam', 'e': 'And'},
                    {'c': 'يَكُنْ', 'd': 'yakun', 'e': 'there is'},
                    {'c': 'لَّهُ', 'd': 'lahu', 'e': 'for Him'},
                    {'c': 'كُفُوًا', 'd': 'kufuwan', 'e': 'any'},
                    {'c': 'أَحَدٌ', 'd': 'aḥadun', 'e': 'equivalent'}
                ]
            }
        }
    };

    // DOM elements
    const surahSelect = document.getElementById('surah-select');
    const loadingElement = document.getElementById('loading');
    const wordCard = document.getElementById('word-card');
    const arabicText = document.getElementById('arabic-text');
    const transliteration = document.getElementById('transliteration');
    const translation = document.getElementById('translation');
    const progress = document.getElementById('progress');
    const audioStatus = document.getElementById('audio-status');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const fullscreenExitBtn = document.getElementById('fullscreen-exit-btn');
    const fullscreenCard = document.getElementById('fullscreen-card');
    const fullscreenWordCard = document.getElementById('fullscreen-word-card');
    const fullscreenArabicText = document.getElementById('fullscreen-arabic-text');
    const fullscreenTransliteration = document.getElementById('fullscreen-transliteration');
    const fullscreenTranslation = document.getElementById('fullscreen-translation');
    const fullscreenProgress = document.getElementById('fullscreen-progress');
    const fullscreenRepeatIndicator = document.getElementById('fullscreen-repeat-indicator');
    const autoPlayToggle = document.getElementById('autoPlayToggle');
    const autoPlayText = document.getElementById('autoPlayText');
    const fullscreenAutoplayBtn = document.getElementById('fullscreen-autoplay-btn');
    const repeatCountInput = document.getElementById('repeat-count');
    const delayMsInput = document.getElementById('delay-ms');
    const repeatIndicator = document.getElementById('repeat-indicator');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const themeToggle = document.getElementById('themeToggle');

    // Display toggle inputs
    const toggleTranslitInput = document.getElementById('toggle-translit');
    const toggleTranslationInput = document.getElementById('toggle-translation');
    const toggleProgressInput = document.getElementById('toggle-progress');
    const toggleRepeatInput = document.getElementById('toggle-repeat');

    // Translation data
    const translations = {
        ar: {
            nav_title: "التنقل",
            display_settings: "إعدادات العرض",
            display_toggles_title: "رؤية الحتوى:",
            toggle_translit: "عرض النطق (النقل الصوتي)",
            toggle_translation: "عرض الترجة",
            toggle_progress: "عرض عدد الكلمات / التقد",
            toggle_repeat: "عرض مؤشر التكرار",
            card_design_title: "تصمي الإطار:",
            text_styles_title: "أنماط النص:",
            autoplay_settings: "إعدادات التشغيل التلقائي",
            label_repeat_count: "عدد تكرار الكلمة:",
            label_delay_ms: "التأخير بين الكلمات (مللي ثانية):",
            start_autoplay: "بدء التشغيل التلقائي",
            stop_autoplay: "إيقاف مؤقت للتشغيل التلقائي",
            label_language: "اللغة:",
            label_card_color: "لون خلفية البطاقة:",
            label_arabic_color: "لون النص العربي:",
            label_translit_color: "لون النقل الصوتي:",
            label_translation_color: "لون الترجة:",
            label_arabic_size: "حج النص العربي (بكسل):",
            label_translit_size: "حج النقل الصوتي (بكسل):",
            label_translation_size: "حج الترجة (بكسل):",
            save_settings: "حفظ الإعدادات",
            progress_title: "نظرة عامة على التقد",
            quick_actions: "إجراءات سريعة",
            bookmarks: "الإشارات المرجعية",
            review: "مراجعة",
            statistics: "الإحصائيات",
            profile_title: "ملفك الشخصي",
            words_learned: "الكلمات الُتعلَّمة",
            surahs_completed: "السور الكتلة",
            learning_days: "أيا التعل",
            day_streak: "سلسلة الأيا",
            settings: "الإعدادات",
            backup_progress: "نسخ التقد احتياطيًا",
            export_data: "تصدير البيانات",
            switch_profile: "تبديل اللف الشخصي",
            logout: "تسجيل الخروج",
            label_select_surah: "اختر السورة:",
            loading_surah: "جارٍ تحيل السورة...",
            footer_text: "تطبيق تعل القرآن للأطفال &copy; 2023 | ص لأغراض تعليية"
        },
        en: {
            nav_title: "Navigation",
            display_settings: "Display Settings",
            display_toggles_title: "Content Visibility:",
            toggle_translit: "Show Pronouncing (Transliteration)",
            toggle_translation: "Show Translation",
            toggle_progress: "Show Word Count / Progress",
            toggle_repeat: "Show Repeat Indicator",
            card_design_title: "Card Design:",
            text_styles_title: "Text Styles:",
            autoplay_settings: "Autoplay Settings",
            label_repeat_count: "Word Repeat Count:",
            label_delay_ms: "Delay Between Words (ms):",
            start_autoplay: "Start Autoplay",
            stop_autoplay: "Pause Autoplay",
            label_language: "Language:",
            label_card_color: "Card Background:",
            label_arabic_color: "Arabic Text Color:",
            label_translit_color: "Transliteration Color:",
            label_translation_color: "Translation Color:",
            label_arabic_size: "Arabic Text Size (px):",
            label_translit_size: "Transliteration Size (px):",
            label_translation_size: "Translation Size (px):",
            save_settings: "Save Settings",
            progress_title: "Progress Overview",
            quick_actions: "Quick Actions",
            bookmarks: "Bookmarks",
            review: "Review",
            statistics: "Statistics",
            profile_title: "Your Profile",
            words_learned: "Words Learned",
            surahs_completed: "Surahs Completed",
            learning_days: "Learning Days",
            day_streak: "Day Streak",
            settings: "Settings",
            backup_progress: "Backup Progress",
            export_data: "Export Data",
            switch_profile: "Switch Profile",
            logout: "Logout",
            label_select_surah: "Select Surah:",
            loading_surah: "Loading Surah...",
            footer_text: "Kids Quran Learning App &copy; 2023 | Designed for educational purposes"
        },
        es: {
            nav_title: "Navegación",
            display_settings: "Configuración de Pantalla",
            display_toggles_title: "Visibilidad del Contenido:",
            toggle_translit: "Mostrar Pronunciación (Transliteración)",
            toggle_translation: "Mostrar Traducción",
            toggle_progress: "Mostrar Recuento / Progreso de Palabras",
            toggle_repeat: "Mostrar Indicador de Repetición",
            card_design_title: "Diseño de Tarjeta:",
            text_styles_title: "Estilos de Texto:",
            autoplay_settings: "Configuración de Reproducción Automática",
            label_repeat_count: "Repeticiones de Palabra:",
            label_delay_ms: "Retraso entre Palabras (ms):",
            start_autoplay: "Iniciar Autoplay",
            stop_autoplay: "Pausar Autoplay",
            label_language: "Idioma:",
            label_card_color: "Fondo de Tarjeta:",
            label_arabic_color: "Color de Texto Árabe:",
            label_translit_color: "Color de Transliteración:",
            label_translation_color: "Color de Traducción:",
            label_arabic_size: "Tamaño de Texto Árabe (px):",
            label_translit_size: "Tamaño de Transliteración (px):",
            label_translation_size: "Tamaño de Traducción (px):",
            save_settings: "Guardar Configuración",
            progress_title: "Resumen de Progreso",
            quick_actions: "Acciones Rápidas",
            bookmarks: "Marcadores",
            review: "Revisar",
            statistics: "Estadísticas",
            profile_title: "Tu Perfil",
            words_learned: "Palabras Aprendidas",
            surahs_completed: "Suras Completadas",
            learning_days: "Días de Aprendizaje",
            day_streak: "Racha de Días",
            settings: "Ajustes",
            backup_progress: "Copia de Seguridad",
            export_data: "Exportar Datos",
            switch_profile: "Cambiar Perfil",
            logout: "Cerrar Sesión",
            label_select_surah: "Seleccionar Sura:",
            loading_surah: "Cargando Sura...",
            footer_text: "Aplicación de Aprendizaje de Palabras del Corán para Niños &copy; 2023 | Diseñado con fines educativos"
        }
    };

    // Load user progress from localStorage
    function loadUserProgress() {
        const saved = localStorage.getItem('quranAppProgress');
        if (saved) {
            try {
                userProgress = {...userProgress, ...JSON.parse(saved)};
                // Convert learnedWords arrays back to Sets
                if (userProgress.surahProgress) {
                    for (const surahId in userProgress.surahProgress) {
                        const progressData = userProgress.surahProgress[surahId];
                        if (progressData.learnedWords && !(progressData.learnedWords instanceof Set)) {
                            progressData.learnedWords = new Set(progressData.learnedWords);
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading progress:', e);
            }
        }
        updateProgressUI();
    }

    // Save user progress to localStorage
    function saveUserProgress() {
        localStorage.setItem('quranAppProgress', JSON.stringify(userProgress));
    }

    // Update progress when word is learned
    function updateWordProgress() {
        const surahId = surahSelect.value;
        if (!surahId) return;
        
        if (!userProgress.surahProgress[surahId]) {
            userProgress.surahProgress[surahId] = {
                learnedWords: new Set(),
                totalWords: 0
            };
        }
        
        // Calculate total words for this surah
        if (userProgress.surahProgress[surahId].totalWords === 0 && currentSurah) {
            userProgress.surahProgress[surahId].totalWords = Object.values(currentSurah).reduce((total, ayahData) => {
                if (ayahData && ayahData.w) return total + ayahData.w.length;
                return total;
            }, 0);
        }
        
        userProgress.surahProgress[surahId].learnedWords.add(currentWordIndex);
        
        const totalLearned = Object.values(userProgress.surahProgress).reduce((total, surah) => {
            const learnedWords = Array.isArray(surah.learnedWords) ? new Set(surah.learnedWords) : surah.learnedWords;
            return total + (learnedWords ? learnedWords.size : 0);
        }, 0);
        userProgress.totalWordsLearned = totalLearned;

        updateLearningStreak();
        saveUserProgress();
        updateProgressUI();
    }

    // Update learning streak
    function updateLearningStreak() {
        const today = new Date().toDateString();
        if (userProgress.lastStudyDate !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (userProgress.lastStudyDate === yesterday.toDateString()) {
                userProgress.currentStreak++;
            } else {
                userProgress.currentStreak = 1;
            }
            
            userProgress.learningDays++;
            userProgress.lastStudyDate = today;
        }
    }

    // Update progress UI
    function updateProgressUI() {
        document.getElementById('totalWords').textContent = userProgress.totalWordsLearned;
        document.getElementById('completedSurahs').textContent = userProgress.completedSurahs;
        document.getElementById('learningDays').textContent = userProgress.learningDays;
        document.getElementById('currentStreak').textContent = userProgress.currentStreak;
        
        document.querySelectorAll('.progress-item').forEach(item => {
            const surahId = item.getAttribute('data-surah');
            if (userProgress.surahProgress[surahId]) {
                const progressData = userProgress.surahProgress[surahId];
                const learnedWords = Array.isArray(progressData.learnedWords) ? new Set(progressData.learnedWords) : progressData.learnedWords;
                const learnedCount = learnedWords ? learnedWords.size : 0;
                
                const percent = progressData.totalWords > 0 
                    ? Math.round((learnedCount / progressData.totalWords) * 100) 
                    : 0;
                item.querySelector('.progress-fill').style.width = percent + '%';
                item.querySelector('.progress-percent').textContent = percent + '%';

                if (percent === 100) {
                    if (!userProgress.surahProgress[surahId].completed) {
                        userProgress.surahProgress[surahId].completed = true;
                        userProgress.completedSurahs++;
                    }
                } else {
                    if (userProgress.surahProgress[surahId].completed) {
                        userProgress.surahProgress[surahId].completed = false;
                        userProgress.completedSurahs--;
                    }
                }
            }
        });
        saveUserProgress();
    }

    // Initialize the app
    function initApp() {
        loadUserProgress();
        
        const surahs = Array.from({length: 114}, (_, i) => i + 1);
        const surahNamesArabic = [
            '',
            'الفاتحة','البقرة','آل عمران','النساء','المائدة','الأنعام','الأعراف','الأنفال','التوبة','يونس',
            'هود','يوسف','الرعد','ابراهيم','الحجر','النحل','الإسراء','الكهف','مريم','طه',
            'الأنبياء','الحج','المؤمنون','النّور','الفرقان','الشعراء','النمل','القصص','العنكبوت','الروم',
            'لقمان','السجدة','الأحزاب','سبأ','فاطر','يس','الصافات','ص','الزمر','غافر',
            'فصلت','الشورى','الزخرف','الدخان','الجاثية','الأحقاف','محمد','الفتح','الحجرات','ق',
            'الذاريات','الطور','النجم','القمر','الرحمن','الواقعة','الحديد','المجادلة','الحشر','الممتحنة',
            'الصف','الجمعة','المنافقون','التغابن','الطلاق','التحريم','الملك','القلم','الحاقة','المعارج',
            'نوح','الجن','المزّمّل','المدّثر','القيامة','الإنسان','المرسلات','النبأ','النازعات','عبس',
            'التكوير','الانفطار','المطففين','الانشقاق','البروج','الطارق','الأعلى','الغاشية','الفجر','البلد',
            'الشمس','الليل','الضحى','الشرح','التين','العلق','القدر','البينة','الزلزلة','العاديات',
            'القارعة','التكاثر','العصر','الهمزة','الفيل','قريش','الماعون','الكوثر','الكافرون','النصر',
            'المسد','الإخلاص','الفلق','الناس'
        ];

        surahs.forEach(surahNumber => {
            const option = document.createElement('option');
            option.value = surahNumber;
            const name = surahNamesArabic[surahNumber] || `سورة ${surahNumber}`;
            option.textContent = `${surahNumber} - ${name}`;
            surahSelect.appendChild(option);
        });

        surahSelect.addEventListener('change', loadSurah);
        
        // Card click plays the word audio
        wordCard.addEventListener('click', function(e) {
            // Only play if not dragging (to prevent conflict with swipe)
            if (!isDragging) {
                playCurrentWordAudio();
            }
        });
        
        fullscreenWordCard.addEventListener('click', function(e) {
            if (!isDragging) {
                playCurrentWordAudio();
            }
        });
        
        setupSwipeEvents(wordCard);
        setupSwipeEvents(fullscreenWordCard);
        
        fullscreenBtn.addEventListener('click', enterFullscreen);
        fullscreenExitBtn.addEventListener('click', exitFullscreen);
        
        document.getElementById('save-display-settings').addEventListener('click', saveDisplaySettings);
        
        setupSideNavControls();
        setupButtonEventListeners();

        // Autoplay Toggle in main view
        autoPlayToggle.addEventListener('click', toggleAutoplay);
        // Autoplay Toggle in fullscreen view
        fullscreenAutoplayBtn.addEventListener('click', toggleAutoplay);
        
        // Dark Mode Toggle
        darkModeToggle.addEventListener('click', toggleDarkMode);
        
        // Theme Toggle (Boy/Girl)
        themeToggle.addEventListener('click', toggleTheme);
        
        surahSelect.value = '1';
        loadSavedSettings();
        loadSurah();
    }

    // Setup side nav controls
    function setupSideNavControls() {
        // Language selection
        document.getElementById('app-language').addEventListener('change', function() {
            changeLanguage();
        });
        
        // Display toggles
        toggleTranslitInput.addEventListener('change', function() {
            showTransliteration = this.checked;
            updateCardVisibility();
        });
        toggleTranslationInput.addEventListener('change', function() {
            showTranslation = this.checked;
            updateCardVisibility();
        });
        toggleProgressInput.addEventListener('change', function() {
            showProgress = this.checked;
            updateCardVisibility();
        });
        toggleRepeatInput.addEventListener('change', function() {
            showRepeat = this.checked;
            updateCardVisibility();
        });

        // Card design selection
        document.querySelectorAll('.card-design-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove active class from all options
                document.querySelectorAll('.card-design-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                // Add active class to clicked option
                this.classList.add('active');
                // Update card design
                currentCardDesign = this.getAttribute('data-design');
                updateCardDesign();
                
                // Update card background color when design changes
                const designClasses = ['kids-frame-1', 'kids-frame-2', 'kids-frame-3', 'kids-frame-4', 'kids-frame-5', 'kids-frame-6'];
                let bgColor = '#f0f8ff';
                
                if (isGirlTheme) {
                    if (currentCardDesign === 'kids-frame-2') bgColor = '#fff9e6';
                    else if (currentCardDesign === 'kids-frame-4') bgColor = '#f5fff9';
                    else if (currentCardDesign === 'kids-frame-5') bgColor = '#e6f2ff';
                    else bgColor = '#fff9f9';
                } else {
                    if (currentCardDesign === 'kids-frame-2') bgColor = '#e6f2ff';
                    else if (currentCardDesign === 'kids-frame-4') bgColor = '#f5fff9';
                    else if (currentCardDesign === 'kids-frame-5') bgColor = '#e6f2ff';
                    else bgColor = '#f0f8ff';
                }
                
                document.getElementById('card-color').value = bgColor;
                wordCard.style.backgroundColor = bgColor;
                fullscreenWordCard.style.backgroundColor = bgColor;
            });
        });

        // Display settings (Color/Size)
        document.getElementById('card-color').addEventListener('input', function() {
            wordCard.style.backgroundColor = this.value;
            fullscreenWordCard.style.backgroundColor = this.value;
        });
        
        document.getElementById('arabic-text-color').addEventListener('input', function() {
            arabicText.style.color = this.value;
            fullscreenArabicText.style.color = this.value;
        });
        
        document.getElementById('translit-text-color').addEventListener('input', function() {
            transliteration.style.color = this.value;
            fullscreenTransliteration.style.color = this.value;
        });
        
        document.getElementById('translation-text-color').addEventListener('input', function() {
            translation.style.color = this.value;
            fullscreenTranslation.style.color = this.value;
        });
        
        document.getElementById('arabic-text-size').addEventListener('input', function() {
            arabicText.style.fontSize = this.value + 'px';
            fullscreenArabicText.style.fontSize = this.value + 'px';
        });
        
        document.getElementById('translit-text-size').addEventListener('input', function() {
            transliteration.style.fontSize = this.value + 'px';
            fullscreenTransliteration.style.fontSize = this.value + 'px';
        });
        
        document.getElementById('translation-text-size').addEventListener('input', function() {
            translation.style.fontSize = this.value + 'px';
            fullscreenTranslation.style.fontSize = this.value + 'px';
        });

        // Autoplay settings listeners
  
        repeatCountInput.addEventListener('input', function() {
            repeatCount = parseInt(this.value);
            updateRepeatIndicator();
        });

        delayMsInput.addEventListener('input', function() {
            delayBetweenWords = parseInt(this.value);
        });
    }

    // Setup button event listeners
    function setupButtonEventListeners() {
        // Quick Actions
        document.getElementById('bookmarks-btn').addEventListener('click', function() {
            const msg = translations[currentLanguage]['bookmarks'] ? translations[currentLanguage]['bookmarks'] : 'Bookmarks feature will be implemented soon!';
            alert(msg);
            document.getElementById('sideNav').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });
        
        document.getElementById('review-btn').addEventListener('click', function() {
            alert('Review feature will be implemented soon! Words marked for review will be shown here.');
            document.getElementById('sideNav').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });
        
        document.getElementById('statistics-btn').addEventListener('click', function() {
            const statsMessage = `
Total Words Learned: ${userProgress.totalWordsLearned}
Surahs Completed: ${userProgress.completedSurahs}
Learning Days: ${userProgress.learningDays}
Current Streak: ${userProgress.currentStreak} days
            `;
            alert('Statistics:\n' + statsMessage);
            document.getElementById('sideNav').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });
        
        // Profile Actions
        document.getElementById('backup-btn').addEventListener('click', function() {
            const backupData = JSON.stringify(userProgress);
            localStorage.setItem('quranAppBackup', backupData);
            alert('Progress backed up successfully!');
            document.getElementById('profileModal').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });
        
        document.getElementById('export-btn').addEventListener('click', function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(userProgress));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "quran_progress_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            alert('Data exported successfully!');
            document.getElementById('profileModal').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });
        
        document.getElementById('switch-profile-btn').addEventListener('click', function() {
            alert('Multi-profile feature will be implemented soon!');
            document.getElementById('profileModal').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });
        
        document.getElementById('logout-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout? This will clear all your progress data.')) {
                localStorage.removeItem('quranAppProgress');
                localStorage.removeItem('quranAppBackup');
                userProgress = {
                    totalWordsLearned: 0,
                    completedSurahs: 0,
                    learningDays: 1,
                    currentStreak: 1,
                    surahProgress: {},
                    lastStudyDate: new Date().toDateString()
                };
                updateProgressUI();
                alert('Logged out successfully. All data has been cleared.');
                document.getElementById('profileModal').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
            }
        });

        // Side menu toggles
        document.getElementById('side-theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('side-dark-mode-toggle').addEventListener('click', toggleDarkMode);
    }

    // Save display settings
    function saveDisplaySettings() {
        const language = document.getElementById('app-language').value;
        const cardColor = document.getElementById('card-color').value;
        const arabicColor = document.getElementById('arabic-text-color').value;
        const translitColor = document.getElementById('translit-text-color').value;
        const translationColor = document.getElementById('translation-text-color').value;
        const arabicSize = document.getElementById('arabic-text-size').value;
        const translitSize = document.getElementById('translit-text-size').value;
        const translationSize = document.getElementById('translation-text-size').value;
        const savedRepeatCount = repeatCountInput.value;
        const savedDelayMs = delayMsInput.value;

        // Save Display Toggles
        const savedTranslit = toggleTranslitInput.checked;
        const savedTranslation = toggleTranslationInput.checked;
        const savedProgress = toggleProgressInput.checked;
        const savedRepeat = toggleRepeatInput.checked;
        
        localStorage.setItem('appLanguage', language);
        localStorage.setItem('cardColor', cardColor);
        localStorage.setItem('arabicColor', arabicColor);
        localStorage.setItem('translitColor', translitColor);
        localStorage.setItem('translationColor', translationColor);
        localStorage.setItem('arabicSize', arabicSize);
        localStorage.setItem('translitSize', translitSize);
        localStorage.setItem('translationSize', translationSize);
        localStorage.setItem('repeatCount', savedRepeatCount);
        localStorage.setItem('delayBetweenWords', savedDelayMs);
        localStorage.setItem('darkMode', isDarkMode);
        localStorage.setItem('girlTheme', isGirlTheme);
        localStorage.setItem('cardDesign', currentCardDesign);
        
        // Save toggle states
        localStorage.setItem('showTransliteration', savedTranslit);
        localStorage.setItem('showTranslation', savedTranslation);
        localStorage.setItem('showProgress', savedProgress);
        localStorage.setItem('showRepeat', savedRepeat);
        
        // Apply settings
        changeLanguage();
        wordCard.style.backgroundColor = cardColor;
        fullscreenWordCard.style.backgroundColor = cardColor;
        arabicText.style.color = arabicColor;
        fullscreenArabicText.style.color = arabicColor;
        transliteration.style.color = translitColor;
        fullscreenTransliteration.style.color = translitColor;
        translation.style.color = translationColor;
        fullscreenTranslation.style.color = translationColor;
        arabicText.style.fontSize = arabicSize + 'px';
        fullscreenArabicText.style.fontSize = arabicSize + 'px';
        transliteration.style.fontSize = translitSize + 'px';
        fullscreenTransliteration.style.fontSize = translitSize + 'px';
        translation.style.fontSize = translationSize + 'px';
        fullscreenTranslation.style.fontSize = translationSize + 'px';

        repeatCount = parseInt(savedRepeatCount);
        delayBetweenWords = parseInt(savedDelayMs);
        
        // Apply visibility states
        showTransliteration = savedTranslit;
        showTranslation = savedTranslation;
        showProgress = savedProgress;
        showRepeat = savedRepeat;
        updateCardVisibility();

        // Show confirmation
        const confirmText = translations[currentLanguage]['save_settings'] ? translations[currentLanguage]['save_settings'] + '!' : 'Settings saved!';
        alert(confirmText);
        
        // Close the side nav after saving
        document.getElementById('sideNav').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
    }

    // Load saved settings
    function loadSavedSettings() {
        const savedLanguage = localStorage.getItem('appLanguage');
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';
        const savedGirlTheme = localStorage.getItem('girlTheme') === 'true';
        const savedCardDesign = localStorage.getItem('cardDesign') || 'kids-frame-1';
        
        if (savedLanguage) {
            document.getElementById('app-language').value = savedLanguage;
        }
        
        // Set dark mode if saved
        if (savedDarkMode) {
            isDarkMode = true;
            document.body.classList.add('dark-mode');
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        
        // Set girl theme if saved
        if (savedGirlTheme) {
            isGirlTheme = true;
            document.body.classList.add('girl-theme');
            themeToggle.innerHTML = '<span aria-label="boy">👦</span>';
        }
        
        // Set card design
        currentCardDesign = savedCardDesign;
        updateCardDesign();
        
        // Load color and size settings
        const savedCardColor = localStorage.getItem('cardColor');
        const savedArabicColor = localStorage.getItem('arabicColor');
        const savedTranslitColor = localStorage.getItem('translitColor');
        const savedTranslationColor = localStorage.getItem('translationColor');
        const savedArabicSize = localStorage.getItem('arabicSize');
        const savedTranslitSize = localStorage.getItem('translitSize');
        const savedTranslationSize = localStorage.getItem('translationSize');
        
        if (savedCardColor) {
            wordCard.style.backgroundColor = savedCardColor;
            fullscreenWordCard.style.backgroundColor = savedCardColor;
            document.getElementById('card-color').value = savedCardColor;
        }
        
        if (savedArabicColor) {
            arabicText.style.color = savedArabicColor;
            fullscreenArabicText.style.color = savedArabicColor;
            document.getElementById('arabic-text-color').value = savedArabicColor;
        }
        
        if (savedTranslitColor) {
            transliteration.style.color = savedTranslitColor;
            fullscreenTransliteration.style.color = savedTranslitColor;
            document.getElementById('translit-text-color').value = savedTranslitColor;
        }
        
        if (savedTranslationColor) {
            translation.style.color = savedTranslationColor;
            fullscreenTranslation.style.color = savedTranslationColor;
            document.getElementById('translation-text-color').value = savedTranslationColor;
        }
        
        if (savedArabicSize) {
            arabicText.style.fontSize = savedArabicSize + 'px';
            fullscreenArabicText.style.fontSize = savedArabicSize + 'px';
            document.getElementById('arabic-text-size').value = savedArabicSize;
        }
        
        if (savedTranslitSize) {
            transliteration.style.fontSize = savedTranslitSize + 'px';
            fullscreenTransliteration.style.fontSize = savedTranslitSize + 'px';
            document.getElementById('translit-text-size').value = savedTranslitSize;
        }
        
        if (savedTranslationSize) {
            translation.style.fontSize = savedTranslationSize + 'px';
            fullscreenTranslation.style.fontSize = savedTranslationSize + 'px';
            document.getElementById('translation-text-size').value = savedTranslationSize;
        }

        // Load autoplay settings
        const savedRepeatCount = localStorage.getItem('repeatCount');
        const savedDelayMs = localStorage.getItem('delayBetweenWords');

        if (savedRepeatCount) {
            repeatCountInput.value = savedRepeatCount;
            repeatCount = parseInt(savedRepeatCount);
        }
        if (savedDelayMs) {
            delayMsInput.value = savedDelayMs;
            delayBetweenWords = parseInt(savedDelayMs);
        }

        // Load toggle states
        showTransliteration = localStorage.getItem('showTransliteration') === 'true' || true;
        showTranslation = localStorage.getItem('showTranslation') === 'true' || true;
        showProgress = localStorage.getItem('showProgress') === 'true' || true;
        showRepeat = localStorage.getItem('showRepeat') === 'true' || true;

        toggleTranslitInput.checked = showTransliteration;
        toggleTranslationInput.checked = showTranslation;
        toggleProgressInput.checked = showProgress;
        toggleRepeatInput.checked = showRepeat;

        changeLanguage();
        updateCardVisibility();
    }

    // Update card design
    function updateCardDesign() {
        // Remove all design classes
        const designClasses = ['kids-frame-1', 'kids-frame-2', 'kids-frame-3', 'kids-frame-4', 'kids-frame-5', 'kids-frame-6'];
        designClasses.forEach(design => {
            wordCard.classList.remove(design);
            fullscreenWordCard.classList.remove(design);
        });
        
        // Add current design class
        wordCard.classList.add(currentCardDesign);
        fullscreenWordCard.classList.add(currentCardDesign);
        
        // Update active state in design options
        document.querySelectorAll('.card-design-option').forEach(option => {
            option.classList.remove('active');
            if (option.getAttribute('data-design') === currentCardDesign) {
                option.classList.add('active');
            }
        });
    }

    // Toggle theme (Boy/Girl)
    function toggleTheme() {
        isGirlTheme = !isGirlTheme;
        document.body.classList.toggle('girl-theme');
        
        if (isGirlTheme) {
            themeToggle.innerHTML = '<span aria-label="boy">👦</span>';
        } else {
            themeToggle.innerHTML = '<span aria-label="girl">👧</span>';
        }
        
        // Save theme preference
        localStorage.setItem('girlTheme', isGirlTheme);
    }

    // Toggle dark mode
    function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode');
        
        if (isDarkMode) {
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
        
        // Save dark mode preference
        localStorage.setItem('darkMode', isDarkMode);
    }

    // Function to update the visibility of card elements
    function updateCardVisibility() {
        // Standard Card
        transliteration.style.display = showTransliteration ? 'block' : 'none';
        translation.style.display = showTranslation ? 'block' : 'none';
        progress.style.display = showProgress ? 'block' : 'none';
        repeatIndicator.style.display = showRepeat ? 'block' : 'none';

        // Fullscreen Card
        fullscreenTransliteration.style.display = showTransliteration ? 'block' : 'none';
        fullscreenTranslation.style.display = showTranslation ? 'block' : 'none';
        fullscreenProgress.style.display = showProgress ? 'block' : 'none';
        fullscreenRepeatIndicator.style.display = showRepeat ? 'block' : 'none';

        // Update padding/margins for Arabic text if other elements are hidden
        arabicText.style.marginBottom = (showTransliteration || showTranslation) ? '25px' : '0px';
        fullscreenArabicText.style.marginBottom = (showTransliteration || showTranslation) ? '25px' : '0px';

        updateRepeatIndicator();
    }

    // Function to play current word audio (separate from autoplay)
    function playCurrentWordAudio() {
        if (!currentSurah) return;
        
        // Stop autoplay if it's running
        if (isPlaying) {
            toggleAutoplay();
        }
        
        // Play the current word audio
        const surahNum = surahSelect.value;
        const surahNumPadded = surahNum.toString().padStart(3, '0');
        const ayahNum = currentAyah.toString().padStart(3, '0');

        let wordCountBeforeAyah = 0;
        const ayahKeys = Object.keys(currentSurah).filter(key => key !== 'meta').map(Number).sort((a, b) => a - b);
        
        for (const ayahKey of ayahKeys) {
            const ayahData = currentSurah[ayahKey];
            if (ayahKey < currentAyah) {
                if (ayahData && ayahData.w) wordCountBeforeAyah += ayahData.w.length;
            }
        }

        const indexInAyahZeroBased = currentWordIndex - wordCountBeforeAyah;
        const wordsInAyah = (currentSurah[currentAyah] && currentSurah[currentAyah].w) ? currentSurah[currentAyah].w.length : 0;
        const clampedIndex = Math.max(0, Math.min(indexInAyahZeroBased, wordsInAyah - 1));
        const wordInAyahOneBased = (clampedIndex + 1).toString().padStart(3, '0');

        const audioUrl = `https://audios.quranwbw.com/words/${surahNum}/${surahNumPadded}_${ayahNum}_${wordInAyahOneBased}.mp3`;

        // Create a new audio instance for manual play
        const manualAudio = new Audio();
        manualAudio.src = audioUrl;
        
        manualAudio.play().catch(error => {
            console.error('Error playing audio:', error);
            const statusElement = isFullscreen ? fullscreenAudioStatus : audioStatus;
            statusElement.style.display = 'block';
            const audioNotAvailable = currentLanguage === 'ar' ? 'الصوت غير متوفر' : currentLanguage === 'es' ? 'Audio no disponible' : 'Audio not available';
            statusElement.textContent = audioNotAvailable;
            setTimeout(() => { statusElement.style.display = 'none'; }, 2000);
        });
    }

    // Setup swipe events for a card
    function setupSwipeEvents(cardElement) {
        
        // Touch events
        cardElement.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                isDragging = true;
                dragElement = cardElement;
                initialX = e.touches[0].screenX;
                currentTranslateX = 0;
                dragElement.classList.add('dragging');
            }
        });
        
        cardElement.addEventListener('touchmove', e => {
            if (!isDragging) return;
            const deltaX = e.touches[0].screenX - initialX;
            currentTranslateX = deltaX;
            updateCardPosition();
        }, { passive: true });
        
        cardElement.addEventListener('touchend', e => {
            if (!isDragging) return;
            isDragging = false;
            handleSwipe();
            dragElement.classList.remove('dragging');
            dragElement = null;
        });

        // Mouse events
        cardElement.addEventListener('mousedown', e => {
            isDragging = true;
            dragElement = cardElement;
            initialX = e.clientX;
            currentTranslateX = 0;
            dragElement.classList.add('dragging');

            document.body.addEventListener('mousemove', onMouseMove);
            document.body.addEventListener('mouseup', onMouseUp);
            e.preventDefault();
        });
        
        function onMouseMove(e) {
            if (!isDragging) return;
            const deltaX = e.clientX - initialX;
            currentTranslateX = deltaX;
            updateCardPosition();
        }

        function onMouseUp(e) {
            if (!isDragging) return;
            isDragging = false;
            document.body.removeEventListener('mousemove', onMouseMove);
            document.body.removeEventListener('mouseup', onMouseUp);
            handleSwipe();
            dragElement.classList.remove('dragging');
            dragElement = null;
        }
    }

    // Function to apply real-time position with beauty animation
    function updateCardPosition() {
        if (!dragElement) return;
        
        const maxRotation = 10;
        const maxScale = 0.95;
        const rotationY = Math.min(maxRotation, Math.abs(currentTranslateX) / 20); 
        const rotateDirection = currentTranslateX > 0 ? 1 : -1;
        const scale = 1 - Math.min(0.05, Math.abs(currentTranslateX) / 400);

        dragElement.style.transform = `translateX(${currentTranslateX}px) rotateY(${rotateDirection * rotationY}deg) scale(${scale})`;
    }

    // Handle the final navigation decision after swipe ends
    function handleSwipe() {
        if (!dragElement) return;

        dragElement.style.transform = `translateX(0px) rotateY(0deg) scale(1)`;

        if (currentTranslateX > SWIPE_THRESHOLD) {
            goToNextWord();
        } else if (currentTranslateX < -SWIPE_THRESHOLD) {
            goToPreviousWord();
        }
        
        currentTranslateX = 0;
    }

    // Change language
    function changeLanguage() {
        currentLanguage = document.getElementById('app-language').value;
        document.body.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[currentLanguage] && translations[currentLanguage][key]) {
                element.textContent = translations[currentLanguage][key];
            }
        });

        if (isPlaying) {
            autoPlayText.textContent = translations[currentLanguage]['stop_autoplay'] || 'Pause Autoplay';
        } else {
            autoPlayText.textContent = translations[currentLanguage]['start_autoplay'] || 'Start Autoplay';
        }

        updateRepeatIndicator();
        displayCurrentWord('none');
    }

    // Fullscreen functions
    function enterFullscreen() {
        isFullscreen = true;
        document.body.classList.add('fullscreen-mode');
        fullscreenCard.style.display = 'flex';
        
        if (isPlaying) {
            fullscreenAutoplayBtn.classList.add('playing');
            fullscreenAutoplayBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
            fullscreenAutoplayBtn.classList.remove('playing');
            fullscreenAutoplayBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
        
        updateFullscreenCard();
    }

    function exitFullscreen() {
        isFullscreen = false;
        document.body.classList.remove('fullscreen-mode');
        fullscreenCard.style.display = 'none';
    }

    function updateFullscreenCard() {
        fullscreenArabicText.textContent = arabicText.textContent;
        fullscreenTransliteration.textContent = transliteration.textContent;
        fullscreenTranslation.textContent = translation.textContent;
        fullscreenProgress.textContent = progress.textContent;
        fullscreenRepeatIndicator.textContent = repeatIndicator.textContent;
        
        // Copy styles
        fullscreenWordCard.style.backgroundColor = wordCard.style.backgroundColor;
        fullscreenArabicText.style.color = arabicText.style.color;
        fullscreenTransliteration.style.color = transliteration.style.color;
        fullscreenTranslation.style.color = translation.style.color;
        fullscreenArabicText.style.fontSize = arabicText.style.fontSize;
        fullscreenTransliteration.style.fontSize = transliteration.style.fontSize;
        fullscreenTranslation.style.fontSize = translation.style.fontSize;
        
        // Apply visibility
        updateCardVisibility();
    }

    // Improved loadSurah function with better error handling
    async function loadSurah() {
        const surahId = surahSelect.value;
        if (!surahId) return;
        
        showLoading(true);
        
        if (isPlaying) {
            toggleAutoplay();
        }

        try {
            // First try to load from external JSON file
            const response = await fetch(`data/${surahId}.json`);
            
            if (response.ok) {
                const text = await response.text();
                
                // Check if response is valid JSON
                if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                    currentSurah = JSON.parse(text);
                } else {
                    // If not valid JSON, use sample data
                    throw new Error('Invalid JSON format');
                }
            } else {
                // If file not found, use sample data
                throw new Error('File not found');
            }
        } catch (error) {
            console.warn('Error loading external surah file, using sample data:', error);
            
            // Use sample data as fallback
            if (sampleSurahs[surahId]) {
                currentSurah = sampleSurahs[surahId];
            } else {
                // If no sample data available, create basic structure
                currentSurah = {
                    'meta': {
                        'surah_name': `سورة ${surahId}`,
                        'surah_name_ar': `سورة ${surahId}`,
                        'total_ayahs': 1
                    },
                    '1': {
                        'w': [
                            {'c': 'بِسِْ', 'd': 'bis\'mi', 'e': 'In the name'},
                            {'c': 'اللَّهِ', 'd': 'allahi', 'e': 'of Allah'}
                        ]
                    }
                };
            }
        }
        
        currentWordIndex = 0;
        currentAyah = 1;
        currentRepeat = 0;
        
        if (currentSurah) {
            displayCurrentWord('none');
            updateNavigationButtons();
        }
        
        showLoading(false);
    }

    // Show/hide loading indicator
    function showLoading(show) {
        loadingElement.style.display = show ? 'block' : 'none';
        document.querySelector('.card-container').style.display = show ? 'none' : 'flex';
    }

    // Display the current word with animation
    function displayCurrentWord(direction = 'right') {
        if (!currentSurah) return;
        
        let currentAyahData = null;
        let wordCount = 0;
        let totalWords = 0;

        const ayahKeys = Object.keys(currentSurah).filter(key => key !== 'meta').map(Number).sort((a, b) => a - b);
        
        for (const ayahKey of ayahKeys) {
            const ayahData = currentSurah[ayahKey];
            if (ayahData && ayahData.w) {
                const ayahWordCount = ayahData.w.length;
                totalWords += ayahWordCount;
                if (currentWordIndex < wordCount + ayahWordCount) {
                    currentAyah = ayahKey;
                    currentAyahData = ayahData;
                    break;
                }
                wordCount += ayahWordCount;
            }
        }
        
        if (!currentAyahData || currentWordIndex >= totalWords) {
            if (currentWordIndex >= totalWords && isPlaying) {
                toggleAutoplay();
                return;
            } else if (currentWordIndex >= totalWords) {
                currentWordIndex = totalWords > 0 ? totalWords - 1 : 0;
            } else if (currentWordIndex < 0) {
                currentWordIndex = 0;
            }
            
            wordCount = 0;
            for (const ayahKey of ayahKeys) {
                const ayahData = currentSurah[ayahKey];
                if (ayahData && ayahData.w) {
                    const ayahWordCount = ayahData.w.length;
                    if (currentWordIndex < wordCount + ayahWordCount) {
                        currentAyah = ayahKey;
                        currentAyahData = ayahData;
                        break;
                    }
                    wordCount += ayahWordCount;
                }
            }
        }
        
        const wordIndexInAyah = currentWordIndex - wordCount;
        const word = currentAyahData.w[wordIndexInAyah];
        
        const activeWordCard = isFullscreen ? fullscreenWordCard : wordCard;

        if (direction !== 'none') {
            activeWordCard.classList.remove('active', 'slide-out-left', 'slide-in-right');
            if (direction === 'next') {
                activeWordCard.classList.add('slide-out-left');
            } else if (direction === 'prev') {
                activeWordCard.classList.add('slide-in-right');
            }
        }

        setTimeout(() => {
            arabicText.textContent = word.c;
            transliteration.textContent = word.d;
            translation.textContent = word.e;
            
            if (direction !== 'none') {
                activeWordCard.classList.remove('slide-out-left', 'slide-in-right');
                activeWordCard.classList.add('active');
            }
            
            const safeTotalWords = Object.values(currentSurah).reduce((total, ayahData) => {
                if (ayahData && ayahData.w) return total + ayahData.w.length;
                return total;
            }, 0);
            
            const wordText = translations[currentLanguage]['words_learned'] ? translations[currentLanguage]['words_learned'].split(' ')[0] : 'Word';
            const ofText = currentLanguage === 'ar' ? 'من' : currentLanguage === 'es' ? 'de' : 'of';
            const ayahText = currentLanguage === 'ar' ? 'آية' : currentLanguage === 'es' ? 'Aleya' : 'Ayah';
            const newProgressText = `${wordText} ${currentWordIndex + 1} ${ofText} ${safeTotalWords} (${ayahText}: ${currentAyah})`;
            progress.textContent = newProgressText;
            
            if (isFullscreen) {
                updateFullscreenCard();
            }
            
            updateRepeatIndicator();
            updateCardVisibility();
            
            updateWordProgress();

            if (isPlaying) {
                playCurrentWord();
            }
        }, direction === 'none' ? 0 : 180);
    }

    // Play the current word's audio (for autoplay)
    function playCurrentWord() {
        if (!currentSurah || !isPlaying) return;

        if (currentRepeat >= repeatCount) {
            currentRepeat = 0;
            setTimeout(() => {
                if (isPlaying) goToNextWord();
            }, delayBetweenWords);
            return;
        }

        const surahNum = surahSelect.value;
        const surahNumPadded = surahNum.toString().padStart(3, '0');
        const ayahNum = currentAyah.toString().padStart(3, '0');

        let wordCountBeforeAyah = 0;
        const ayahKeys = Object.keys(currentSurah).filter(key => key !== 'meta').map(Number).sort((a, b) => a - b);
        
        for (const ayahKey of ayahKeys) {
            const ayahData = currentSurah[ayahKey];
            if (ayahKey < currentAyah) {
                if (ayahData && ayahData.w) wordCountBeforeAyah += ayahData.w.length;
            }
        }

        const indexInAyahZeroBased = currentWordIndex - wordCountBeforeAyah;
        const wordsInAyah = (currentSurah[currentAyah] && currentSurah[currentAyah].w) ? currentSurah[currentAyah].w.length : 0;
        const clampedIndex = Math.max(0, Math.min(indexInAyahZeroBased, wordsInAyah - 1));
        const wordInAyahOneBased = (clampedIndex + 1).toString().padStart(3, '0');

        const audioUrl = `https://audios.quranwbw.com/words/${surahNum}/${surahNumPadded}_${ayahNum}_${wordInAyahOneBased}.mp3`;

        // Reset audio and create a new instance for each play
        if (audio) {
            audio.pause();
            audio = null;
        }
        audio = new Audio();
        
        // Add event listeners before setting src
        audio.addEventListener('ended', handleAudioEnded);
        audio.addEventListener('error', handleAudioError);
        
        audio.src = audioUrl;
        
        // Use a promise-based approach for better Android compatibility
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                const statusElement = isFullscreen ? fullscreenAudioStatus : audioStatus;
                statusElement.style.display = 'none';
            }).catch(error => {
                console.error('Error playing audio:', error);
                handleAudioError();
            });
        }
    }

    // Separate audio event handlers for better management
    function handleAudioEnded() {
        currentRepeat++;
        updateRepeatIndicator();
        
        if (currentRepeat < repeatCount) {
            setTimeout(() => {
                if (isPlaying) playCurrentWord();
            }, 500);
        } else {
            currentRepeat = 0;
            updateRepeatIndicator();
            
            if (isPlaying) {
                setTimeout(() => {
                    if (isPlaying) goToNextWord();
                }, delayBetweenWords);
            } else {
                const statusElement = isFullscreen ? fullscreenAudioStatus : audioStatus;
                statusElement.style.display = 'none';
            }
        }
    }

    function handleAudioError() {
        console.error('Error playing audio');
        const statusElement = isFullscreen ? fullscreenAudioStatus : audioStatus;
        statusElement.style.display = 'block';
        const audioNotAvailable = currentLanguage === 'ar' ? 'الصوت غير متوفر' : currentLanguage === 'es' ? 'Audio no disponible' : 'Audio not available';
        statusElement.textContent = audioNotAvailable;
        
        currentRepeat++;
        updateRepeatIndicator();
        if (isPlaying && currentRepeat < repeatCount) {
             setTimeout(() => {
                 if (isPlaying) playCurrentWord();
             }, 500);
        } else if (isPlaying && currentRepeat >= repeatCount) {
             setTimeout(() => {
                 if (isPlaying) goToNextWord();
             }, delayBetweenWords);
        } else {
             setTimeout(() => { statusElement.style.display = 'none'; }, 1200);
        }
    }

    // Toggle Autoplay
    function toggleAutoplay() {
        if (!currentSurah) {
            alert(translations[currentLanguage]['label_select_surah'] || 'Please select a Surah first.');
            return;
        }

        isPlaying = !isPlaying;

        if (isPlaying) {
            // UI updates for START
            autoPlayToggle.classList.add('playing');
            autoPlayToggle.innerHTML = `<i class="fas fa-pause"></i> <span data-i18n="stop_autoplay">${translations[currentLanguage]['stop_autoplay'] || 'Pause Autoplay'}</span>`;
            
            fullscreenAutoplayBtn.classList.add('playing');
            fullscreenAutoplayBtn.innerHTML = '<i class="fas fa-pause"></i>';
            
            // Start playing
            currentRepeat = 0;
            playCurrentWord();
        } else {
            // UI updates for STOP
            autoPlayToggle.classList.remove('playing');
            autoPlayToggle.innerHTML = `<i class="fas fa-play"></i> <span data-i18n="start_autoplay">${translations[currentLanguage]['start_autoplay'] || 'Start Autoplay'}</span>`;
            
            fullscreenAutoplayBtn.classList.remove('playing');
            fullscreenAutoplayBtn.innerHTML = '<i class="fas fa-play"></i>';
            
            // Properly stop audio and clean up
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
        }
    }

    // Navigation functions
    function goToPreviousWord() {
        if (currentWordIndex > 0) {
            if (isPlaying) toggleAutoplay(); 
            currentWordIndex--;
            currentRepeat = 0;
            displayCurrentWord('prev');
            updateNavigationButtons();
        }
    }

    function goToNextWord() {
        const totalWords = Object.values(currentSurah).reduce((total, ayahData) => {
            if (ayahData && ayahData.w) return total + ayahData.w.length;
            return total;
        }, 0);
        
        if (currentWordIndex < totalWords - 1) {
            currentWordIndex++;
            currentRepeat = 0;
            displayCurrentWord('next');
            updateNavigationButtons();
        } else {
            if (isPlaying) {
                 toggleAutoplay();
            }
            
            const endText = currentLanguage === 'ar' ? 'نهاية السورة' : currentLanguage === 'es' ? 'Fin de la Sura' : 'End of Surah';
            alert(endText);
        }
    }

    function updateNavigationButtons() {
        // Navigation button update logic if needed
    }

    // Update Repeat Indicator
    function updateRepeatIndicator() {
        const repeatText = translations[currentLanguage]['label_repeat_count'] ? translations[currentLanguage]['label_repeat_count'].split(':')[0] : 'Repeat';
        
        const displayRepeatCount = repeatCount > 0 ? repeatCount : 1; 

        const text = showRepeat && repeatCount > 0 && currentRepeat > 0 ? `${repeatText}: ${currentRepeat}/${displayRepeatCount}` : '';
        
        repeatIndicator.textContent = text;
        repeatIndicator.style.display = showRepeat ? 'block' : 'none';
        
        if (isFullscreen) {
            fullscreenRepeatIndicator.textContent = text;
            fullscreenRepeatIndicator.style.display = showRepeat ? 'block' : 'none';
        }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        
        // Side navigation functionality
        const menuBtn = document.getElementById('menuBtn');
        const closeNav = document.getElementById('closeNav');
        const sideNav = document.getElementById('sideNav');
        const overlay = document.getElementById('overlay');
        const profileBtn = document.getElementById('profileBtn');
        const profileModal = document.getElementById('profileModal');
        const closeProfile = document.getElementById('closeProfile');

        menuBtn.addEventListener('click', function() {
            sideNav.classList.add('active');
            overlay.classList.add('active');
        });

        closeNav.addEventListener('click', function() {
            sideNav.classList.remove('active');
            overlay.classList.remove('active');
        });

        profileBtn.addEventListener('click', function() {
            profileModal.classList.add('active');
            overlay.classList.add('active');
        });

        closeProfile.addEventListener('click', function() {
            profileModal.classList.remove('active');
            overlay.classList.remove('active');
        });

        overlay.addEventListener('click', function() {
            sideNav.classList.remove('active');
            profileModal.classList.remove('active');
            overlay.classList.remove('active');
        });

        // Progress items click to load surah
        document.querySelectorAll('.progress-item').forEach(item => {
            item.addEventListener('click', function() {
                const surahId = this.getAttribute('data-surah');
                surahSelect.value = surahId;
                loadSurah();
                sideNav.classList.remove('active');
                overlay.classList.remove('active');
            });
        });
    });
    </script>
</body>
</html>
